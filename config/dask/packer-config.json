{"variables": {"project_id": "{{env `GCP_PROJECT`}}", "region": "{{env `GCP_REGION`}}", "zone": "{{env `GCP_ZONE`}}"}, "builders": [{"type": "googlecompute", "project_id": "{{user `project_id`}}", "region": "{{user `region`}}", "zone": "{{user `zone`}}", "machine_type": "n1-standard-8", "ssh_username": "packer", "source_image": "ubuntu-minimal-1804-bionic-v20201014", "on_host_maintenance": "TERMINATE", "image_description": "UKB GWAS Dask Image", "image_name": "ukb-gwas-pipeline-nealelab-dask-{{timestamp}}", "image_licenses": ["projects/vm-options/global/licenses/enable-vmx"], "disk_size": 50, "metadata": {"user-data": "#cloud-config\ngroups:\n- docker\npackages:\n- apt-transport-https\n- ca-certificates\n- curl\n- gnupg-agent\n- software-properties-common\n- ubuntu-drivers-common\nruncmd:\n- curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -\n- add-apt-repository \"deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release\n  -cs) stable\"\n- apt-get update -y\n- apt-get install -y docker-ce docker-ce-cli containerd.io\n- systemctl start docker\n- systemctl enable docker\n- docker run --net=host   -e PUBLIC_INGRESS=False eczech/ukb-gwas-pipeline-nealelab:v2.30.0\n  dask-scheduler --version\n- curl -sSO https://dl.google.com/cloudagents/add-monitoring-agent-repo.sh\n- bash add-monitoring-agent-repo.sh\n- apt-get update\n- apt-get install -y stackdriver-agent\n- service stackdriver-agent start\nsystem_info:\n  default_user:\n    groups:\n    - docker\nwrite_files:\n- content: 'net.ipv4.conf.all.forwarding=1\n\n    '\n  path: /etc/sysctl.d/enabled_ipv4_forwarding.conf\n"}}], "provisioners": [{"type": "shell", "inline": ["echo 'Waiting for cloud-init'; while [ ! -f /var/lib/cloud/instance/boot-finished ]; do sleep 1; done; echo 'Done'"]}]}
